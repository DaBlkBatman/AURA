<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA Full Ritual PWA</title>

  <!-- PWA meta -->
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#6a00f4" />
  <link rel="manifest" href="manifest.json" />

  <!-- Core styles -->
  <style>
    body { margin:0; font-family:sans-serif; transition:background 1s; }
    body[sky="clear"]        { background:#87ceeb; }
    body[sky="partly-cloudy"]{ background:#b0c4de; }

    .loading-screen {
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      height:100vh; text-align:center; background:#111; color:#fff;
    }
    .spinner {
      width:80px; height:80px;
      border:8px solid #444;
      border-top:8px solid #6a00f4;
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-bottom:1rem;
    }
    @keyframes spin { to { transform:rotate(360deg) } }

    .progress-bar {
      width:80%; height:12px; background:#444;
      border-radius:6px; overflow:hidden; margin:1rem 0;
    }
    .progress { height:100%; width:0; background:#6a00f4; transition:width .3s; }

    .sign-in {
      display:flex; flex-direction:column;
      align-items:center; margin:2rem;
    }
    .sign-in input,
    .sign-in button {
      font-size:1rem; padding:.5rem; margin:.5rem 0;
    }

    .home-sanctum { padding:1rem; }
    .ritual {
      background:rgba(255,255,255,0.8);
      padding:.75rem; margin:.5rem 0; border-radius:8px;
    }
    .ritual h3 { margin:0 0 .25rem; }

    #plant-scene { width:100%; height:300px; }
  </style>

  <!-- Three.js & GLTFLoader -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.137.5/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.137.5/examples/js/loaders/GLTFLoader.js"></script>
</head>
<body sky="clear">
  <div id="root"></div>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <script type="text/babel">
    /*************************
     *  3.1 PWA: Service Worker
     *************************/
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('[PWA] SW registered'))
        .catch(e => console.error('[PWA] SW failed', e));
    }

    /*************************
     *  3.2 CORE SERVICES & STATE
     *************************/
    let dataChannel = null;
    let signalingSocket = null;
    let meshLog = [];
    const meshSubs = new Set();

    async function initMesh(roomId) {
      signalingSocket = new WebSocket('wss://your-signaling-server');
      signalingSocket.onopen = () => {
        signalingSocket.send(JSON.stringify({ type:'join', room:roomId }));
      };

      const pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
      dataChannel = pc.createDataChannel('mesh');
      dataChannel.onmessage = evt => {
        const e = JSON.parse(evt.data);
        meshLog.push(e);
        meshSubs.forEach(fn => fn(e));
      };

      signalingSocket.onmessage = async msg => {
        const data = JSON.parse(msg.data);
        if (data.type === 'offer') {
          await pc.setRemoteDescription(data.offer);
          const ans = await pc.createAnswer();
          await pc.setLocalDescription(ans);
          signalingSocket.send(JSON.stringify({ type:'answer', answer:ans }));
        }
        if (data.type === 'answer') {
          await pc.setRemoteDescription(data.answer);
        }
        if (data.type === 'ice') {
          await pc.addIceCandidate(data.candidate);
        }
      };

      pc.onicecandidate = e => {
        if (e.candidate)
          signalingSocket.send(JSON.stringify({ type:'ice', candidate:e.candidate }));
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      signalingSocket.send(JSON.stringify({ type:'offer', offer }));
    }

    function meshJoin(e) {
      meshLog.push(e);
      meshSubs.forEach(fn=>fn(e));
      if (dataChannel && dataChannel.readyState === 'open')
        dataChannel.send(JSON.stringify(e));
    }

    function subscribeMesh(fn){
      meshSubs.add(fn);
      return ()=> meshSubs.delete(fn);
    }

    async function fetchLocalWeather(){
      return { sky: Math.random()<.5?'clear':'partly-cloudy', temp:20 + Math.random()*5 };
    }

    let mood = 0.5;
    const moodSubs = new Set();
    setInterval(()=>{
      mood = Math.random();
      moodSubs.forEach(fn => fn(mood));
    }, 3000);
    function subscribeMood(fn){
      moodSubs.add(fn);
      fn(mood);
      return ()=> moodSubs.delete(fn);
    }

    function vibrate(p){ navigator.vibrate?.(p); }

    const CONT_KEY = 'AURA_STATE';
    function saveState(s){ localStorage.setItem(CONT_KEY, JSON.stringify(s)); }
    function loadState(){ const j = localStorage.getItem(CONT_KEY); return j ? JSON.parse(j) : {}; }
    function syncStateWithCloud(s){ console.log('[Cont] sync', s); }

    async function suggestRitual(){ return { text:'Trust your breath, honor today’s harvest.' }; }
    function fetchTemplates(){
      return Promise.resolve([
        {id:'t1',name:'Moon Rite',description:'Balance tides'},
        {id:'t2',name:'Sun Salute',description:'Invigorate spirit'}
      ]);
    }
    function purchaseTemplate(id){ console.log('[Market] bought', id); }

    /*************************
     *  3.3 LOADER
     *************************/
    function LoadingScreen({ onComplete }) {
      const [steps, setSteps] = React.useState([]);
      const tasks = React.useMemo(() => [
        { name:'Install SW', fn:() => navigator.serviceWorker.ready },
        { name:'Init Mesh', fn:() => initMesh('public-harvest') },
        { name:'Fetch Weather', fn: fetchLocalWeather },
        { name:'Load Templates', fn: fetchTemplates },
        { name:'Init Ritual AI', fn: suggestRitual }
      ], []);

      React.useEffect(()=>{
        const audio = new Audio('/audio/loader-ambient.mp3');
        audio.loop = true;
        audio.play().catch(()=>{});

        let alive = true, res = [];
        tasks.reduce((p,task,i) =>
          p.then(() => task.fn()
            .then(() => alive && res.push({name:task.name, status:'OK'}))
            .catch(() => alive && res.push({name:task.name, status:'FAIL'}))
            .finally(()=>{
              if (!alive) return;
              setSteps([...res]);
              const pct = Math.floor((res.length/tasks.length)*100);
              document.querySelector('.progress').style.width = pct + '%';
            })
          ), Promise.resolve()
        ).then(()=>{
          if (!alive) return;
          audio.pause();
          setTimeout(onComplete, 300);
        });

        return ()=>{ alive = false; audio.pause(); };
      }, [tasks, onComplete]);

      return (
        <div className="loading-screen">
          <div className="spinner"></div>
          <h2>Booting AURA...</h2>
          <div className="progress-bar"><div className="progress"></div></div>
          <ul>{steps.map((s,i)=><li key={i}>{s.name}: {s.status}</li>)}</ul>
        </div>
      );
    }

    /*************************
     *  3.4 RITUAL MODULES
     *************************/
    // 3.4.1 Harvest Ceremony with Three.js
    function HarvestCeremony(){
      React.useEffect(()=>{
        const container = document.getElementById('plant-scene');
        const scene     = new THREE.Scene();
        const camera    = new THREE.PerspectiveCamera(45, container.clientWidth/container.clientHeight, 0.1, 1000);
        const renderer  = new THREE.WebGLRenderer({ antialias:true, alpha:true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        const light = new THREE.HemisphereLight(0xffffff,0x444444,1);
        scene.add(light);
        camera.position.set(0,1.5,3);

        const loader = new THREE.GLTFLoader();
        loader.load('/models/cannabisField.glb', gltf=>{
          const plant = gltf.scene;
          plant.scale.set(0.1,0.1,0.1);
          scene.add(plant);
          let scale = 0.1;
          function animate(){
            requestAnimationFrame(animate);
            if(scale < 1){ scale += 0.002; plant.scale.set(scale,scale,scale); }
            plant.rotation.y += 0.005;
            renderer.render(scene, camera);
          }
          animate();
        });

        return ()=> renderer.dispose();
      }, []);

      return (
        <div className="ritual">
          <h3>Harvest Ceremony</h3>
          <div id="plant-scene"></div>
        </div>
      );
    }

    // 3.4.2 Tincture Crafting with Web Bluetooth
    function TinctureCrafting(){
      const [status,setStatus] = React.useState('Disconnected');
      const SERVICE_UUID = '0000ffee-0000-1000-8000-00805f9b34fb';
      const CHAR_UUID    = '0000feed-0000-1000-8000-00805f9b34fb';

      async function connectDiffuser(){
        try {
          setStatus('Requesting device…');
          const device = await navigator.bluetooth.requestDevice({ filters:[{services:[SERVICE_UUID]}] });
          const server = await device.gatt.connect();
          const svc    = await server.getPrimaryService(SERVICE_UUID);
          const chr    = await svc.getCharacteristic(CHAR_UUID);
          await chr.writeValue(Uint8Array.of(1));
          setStatus('Diffuser connected');
        }
        catch(e){
          setStatus('Connection failed');
        }
      }

      return (
        <div className="ritual">
          <h3>Tincture Crafting</h3>
          <p>Status: {status}</p>
          <button onClick={connectDiffuser}>Connect Diffuser</button>
        </div>
      );
    }

    // 3.4.3 Other Ritual Stubs
    function CompanionDance({ companion }){
      React.useEffect(()=> companion.animation.play('dance'), [companion]);
      return <div className="ritual"><h3>Companion Dance</h3><p>Your companion moves in harmony.</p></div>;
    }

    function CommunityRitualSpace(){
      const [events,setEvents] = React.useState([]);
      React.useEffect(()=>{
        meshJoin({user:'All',message:'Welcome!'});
        const unsub = subscribeMesh(evt => setEvents(e => [...e, evt]));
        return unsub;
      }, []);
      return <div className="ritual"><h3>Community Space</h3><ul>{events.map((e,i)=><li key={i}>{e.user}: {e.message}</li>)}</ul></div>;
    }

    function DynamicWeather(){
      const [w,setW] = React.useState({sky:'clear',temp:0});
      React.useEffect(()=> fetchLocalWeather().then(d=>{
        setW(d);
        document.body.setAttribute('sky', d.sky);
      }), []);
      return <div className="ritual"><h3>Dynamic Weather</h3><p>Sky: {w.sky}, Temp: {w.temp.toFixed(1)}°C</p></div>;
    }

    function EmotionSoundscape(){
      const [lvl,setLvl] = React.useState(0.5);
      React.useEffect(()=> subscribeMood(setLvl), []);
      React.useEffect(()=>{
        const track = lvl>0.7 ? '/audio/happy.mp3' : '/audio/ambient.mp3';
        new Audio(track).play();
      }, [lvl]);
      return <div className="ritual"><h3>Emotion Soundscape</h3><p>Mood: {lvl.toFixed(2)}</p></div>;
    }

    function HapticIntegration(){
      React.useEffect(()=> vibrate([100,50,100]), []);
      return <div className="ritual"><h3>Haptic Integration</h3><p>Pulses resonate.</p></div>;
    }

    function RitualSuggestions(){
      const [sug,setSug] = React.useState('…');
      React.useEffect(()=> suggestRitual().then(r=>setSug(r.text)), []);
      return <div className="ritual"><h3>Ritual AI Suggestion</h3><p>{sug}</p></div>;
    }

    function Marketplace(){
      const [templates,setTemplates] = React.useState([]);
      React.useEffect(()=> fetchTemplates().then(setTemplates), []);
      return (
        <div className="ritual">
          <h3>Marketplace</h3>
          <ul>
            {templates.map(t=>(
              <li key={t.id}>
                {t.name}: {t.description}
                <button onClick={()=>purchaseTemplate(t.id)}>Buy</button>
              </li>
            ))}
          </ul>
        </div>
      );
    }

    /*************************
     *  3.5 Sign-In & Home
     *************************/
    function SignIn({ onSignIn }){
      const [name,setName] = React.useState('');
      return (
        <div className="sign-in">
          <h2>Welcome to AURA</h2>
          <input placeholder="Your Name" value={name} onChange={e=>setName(e.target.value)} />
          <button disabled={!name.trim()} onClick={()=>onSignIn({name:name.trim()})}>Sign In</button>
        </div>
      );
    }

    function HomeSanctum({ user, companion }){
      React.useEffect(()=>{
        const s = loadState();
        if (!s.visited) {
          saveState({ visited:true });
          syncStateWithCloud({ visited:true });
        }
      }, []);

      return (
        <div className="home-sanctum">
          <h2>Home Sanctum for {user.name}</h2>
          <HarvestCeremony/>
          <TinctureCrafting/>
          <CompanionDance companion={companion}/>
          <CommunityRitualSpace/>
          <DynamicWeather/>
          <EmotionSoundscape/>
          <HapticIntegration/>
          <RitualSuggestions/>
          <Marketplace/>
        </div>
      );
    }

    /*************************
     *  3.6 App Entry
     *************************/
    function App(){
      const [stage,setStage] = React.useState('loading');
      const [user,setUser]   = React.useState(null);
      const companion = { animation:{ play:r=>console.log('[Companion] play',r) } };

      if (stage === 'loading')
        return <LoadingScreen onComplete={()=>setStage('signin')} />;

      if (stage === 'signin')
        return <SignIn onSignIn={u=>{ setUser(u); setStage('home'); }} />;

      return <HomeSanctum user={user} companion={companion} />;
    }

    ReactDOM.render(<App/>, document.getElementById('root'));
  </script>
</body>
</html>
